<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <script src="js/mui.min.js"></script>
    <link href="css/mui.min.css" rel="stylesheet"/>
    <script type="text/javascript" charset="utf-8">
      	mui.init();
      	mui('.mui-input-row input').input();
    </script>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
		<h1 class="mui-title">登录</h1>
	</header>
	<div class="mui-content">
		<form class="mui-input-group">
		    <div class="mui-input-row">
		        <label>用户名</label>
		    <input id="account" type="text" class="mui-input-clear" placeholder="请输入手机号">
		    </div>
		    <div class="mui-input-row">
		        <label>密码</label>
		        <input id="password" type="password" class="mui-input-password" placeholder="请输入密码">
		    </div>
		</form>
		<div class="mui-button-row">
	        <button id="login" type="button" class="mui-btn mui-btn-block mui-btn-primary" >登陆</button>
	        <div class="link-area"><a id='reg'>注册账号</a> <span class="spliter">|</span> <a id='forgetPassword'>忘记密码</a>
			</div>
	   </div>
	</div>
</body>
<script type="text/javascript" src="js/app.js" ></script>
<script type="text/javascript">
	(function($, doc) {
		$.init({
			statusBarBackground: '#f7f7f7'
		});
		$.plusReady(function() {
			plus.screen.lockOrientation("portrait-primary");
			var settings = app.getSettings();
			var state = app.getState();
			var mainPage = plus.webview.getWebviewById("main");
			var main_loaded_flag = false;
			if(!mainPage){
				mainPage = $.preload({
					"id": 'main',
					"url": 'main.html'
				});
			}else{
				main_loaded_flag = true;
			}
			
			mainPage.addEventListener("loaded",function () {
				main_loaded_flag = true;
			});
			var toMain = function() {
				//使用定时器的原因：
				//可能执行太快，main页面loaded事件尚未触发就执行自定义事件，此时必然会失败
				var id = setInterval(function () {
					if(main_loaded_flag){
						clearInterval(id);
						$.fire(mainPage, 'show', null);
						mainPage.show("pop-in");
					}
				},20);
			};

			// close splash
			setTimeout(function() {
				//关闭 splash
				plus.navigator.closeSplashscreen();
			}, 600);
			//检查 "登录状态/锁屏状态" 结束
			var loginButton = doc.getElementById('login');
			var accountBox = doc.getElementById('account');
			var passwordBox = doc.getElementById('password');
			var regButton = doc.getElementById('reg');
			var forgetButton = doc.getElementById('forgetPassword');
			loginButton.addEventListener('tap', function(event) {
				var loginInfo = {
					account: accountBox.value,
					password: passwordBox.value
				};
				app.login(loginInfo, function(err) {
					if (err) {
						plus.nativeUI.toast(err);
						return;
					}
					toMain();
				});
			});
			$.enterfocus('#login-form input', function() {
				$.trigger(loginButton, 'tap');
			});
			regButton.addEventListener('tap', function(event) {
				$.openWindow({
					url: 'reg.html',
					id: 'reg',
					preload: true,
					show: {
						aniShow: 'pop-in'
					},
					styles: {
						popGesture: 'hide'
					},
					waiting: {
						autoShow: false
					}
				});
			}, false);
			forgetButton.addEventListener('tap', function(event) {
				$.openWindow({
					url: 'forget_password.html',
					id: 'forget_password',
					preload: true,
					show: {
						aniShow: 'pop-in'
					},
					styles: {
						popGesture: 'hide'
					},
					waiting: {
						autoShow: false
					}
				});
			}, false);
			//
			window.addEventListener('resize', function() {
				oauthArea.style.display = document.body.clientHeight > 400 ? 'block' : 'none';
			}, false);
			//
			var backButtonPress = 0;
			$.back = function(event) {
				backButtonPress++;
				if (backButtonPress > 1) {
					plus.runtime.quit();
				} else {
					plus.nativeUI.toast('再按一次退出应用');
				}
				setTimeout(function() {
					backButtonPress = 0;
				}, 1000);
				return false;
			};
		});
	}(mui, document));
</script>
</html>